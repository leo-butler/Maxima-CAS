# Work in progress - xmaxima support files for windows  
#
# Following files are to be installed in $(prefix)/bin
#
# - xmaxima.exe
# - winkill.exe
# - tclwinkill.dll
prefix=@prefix@
TCLKITSH = tclkitsh.exe
TCLKITDIR = /c/star
SDXDIR = $(TCLKITDIR)
GNUPLOTDIR = /c/programs/gnuplot

GCCPREFIX=/mingw
GCCVER=3.3.1

all: xmaxima.exe winkill.exe tclwinkill.dll

../xmaxima: 
	(cd ..; $(MAKE) xmaxima)

xmaxima.tcl: ../xmaxima
	cp ../xmaxima xmaxima.tcl

xmaxima.exe: xmaxima.tcl
	rm -rf xmaxima.vfs
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit qwrap xmaxima.tcl && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit unwrap xmaxima.kit && \
	$(TCLKITDIR)/$(TCLKITSH) $(SDXDIR)/sdx.kit wrap xmaxima.exe \
		-runtime $(TCLKITDIR)/tclkit.exe xmaxima.kit

winkill.exe: winkill.c
	gcc -Wall -o winkill.exe winkill.c 

tclwinkill.dll: tclwinkill.c
	gcc -Wall -shared tclwinkill.c -ltclstub84 -o tclwinkill.dll

gcccopy:
	test -d "$(prefix)/bin" || mkdir -p "$(prefix)/bin"
	test -d "$(prefix)/include" || mkdir -p "$(prefix)/include"
	test -d "$(prefix)/include/sys" || mkdir -p "$(prefix)/include/sys"
	test -d "$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)" \
		|| mkdir -p "$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)"
	test -d "$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)/include" \
		|| mkdir -p "$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)/include"
	cp $(GCCPREFIX)/bin/gcc.exe $(prefix)/bin
	cp $(GCCPREFIX)/bin/mingwm10.dll $(prefix)/bin
	cp $(GCCPREFIX)/bin/tclpip84.dll $(prefix)/bin
	cp $(GCCPREFIX)/include/stdio.h $(prefix)/include
	cp $(GCCPREFIX)/include/varargs.h $(prefix)/include
	cp $(GCCPREFIX)/include/setjmp.h $(prefix)/include
	cp $(GCCPREFIX)/include/stddef.h $(prefix)/include
	cp $(GCCPREFIX)/include/_mingw.h $(prefix)/include
	cp $(GCCPREFIX)/include/math.h $(prefix)/include
	cp $(GCCPREFIX)/include/unistd.h $(prefix)/include
	cp $(GCCPREFIX)/include/io.h $(prefix)/include
	cp $(GCCPREFIX)/include/process.h $(prefix)/include
	cp $(GCCPREFIX)/include/getopt.h $(prefix)/include
	cp $(GCCPREFIX)/include/sys/*.h $(prefix)/include/sys
	cp $(GCCPREFIX)/lib/gcc-lib/mingw32/$(GCCVER)/cc1.exe \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/bin/as.exe \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/lib/gcc-lib/mingw32/$(GCCVER)/specs  \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)
	cp $(GCCPREFIX)/lib/gcc-lib/mingw32/$(GCCVER)/include/*.h  \
		$(prefix)/lib/gcc-lib/mingw32/$(GCCVER)/include

# Install the gnuplot binary files in bin
gnuplot: 
	cp $(GNUPLOTDIR)/bin/wgnuplot.exe $(prefix)/bin
	cp $(GNUPLOTDIR)/bin/wgnuplot.hlp $(prefix)/bin
	cp $(GNUPLOTDIR)/bin/wgnuplot.mnu $(prefix)/bin

# Some little hacks for Windows
fixes: fix_maxima_bat fix_maxima_init

# Installed maxima.bat must have DOS line termination on win9x
fix_maxima_bat: 
		unix2dos "@prefix@/bin/maxima.bat"

# Add some magic to reliably find gcc.exe
fix_maxima_init:
	grep -q compiler @prefix@/share/maxima/@VERSION@/share/maxima-init.lisp || \
	( echo;\
	echo ';; Hard code the path to the included gcc compiler';\
	echo ';; The path must have \ directory separators on windows 9x';\
	echo '(setq compiler::*cc*';\
	echo "  (concatenate 'string ";\
	echo '     (substitute #\\ #\/ *maxima-prefix*)';\
	echo '     "\\bin\\" ';\
	echo '     compiler::*cc*)';\
	echo ')';\
	echo ;\
	 ) >> @prefix@/share/maxima/@VERSION@/share/maxima-init.lisp 

install: xmaxima.exe winkill.exe tclwinkill.dll gnuplot fixes
	cp xmaxima.exe winkill.exe tclwinkill.dll "@prefix@/bin"
	cp readme.txt "@prefix@"
